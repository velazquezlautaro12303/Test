/*******************************************************************************************************************************//**
 *
 * @file		filesystem.c
 * @proyect		EXAMPLE
 * @author		Velazquez LautaroÂ¿
 *
 **********************************************************************************************************************************/


/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/

#include "filesystem.h"
#include <string.h>

/***********************************************************************************************************************************
 *** PRIVATE DEFINES
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE MACROS
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE DATA
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PUBLIC VARIABLES
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE VARIABLES
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE FUNCTIONS PROTOTYPE
 **********************************************************************************************************************************/

static int isAvailableForWrite(Measurements page);

/***********************************************************************************************************************************
 *** PUBLIC FUNCTIONS
 **********************************************************************************************************************************/

void filesystem_init()
{
	w25q80dv_init();
}

void filesystem_write(Measurements data)
{
	int pos = -1;
	Measurements mapBits;
	for (int i = 0; i < CANT_PAGES; i++)
	{
		mapBits = w25q80db_read(i * SIZE_PAGE);
		pos = isAvailableForWrite(mapBits);
		if (pos > 0)
		{
			((uint8_t *)&mapBits)[i] = 0xFF;
			w25q80dv_write(mapBits, i * SIZE_PAGE);
			w25q80dv_write(data, pos * sizeof(Measurements) + i * SIZE_PAGE);
			break;
		}
	}
}

bool filesystem_read(uint64_t id, Measurements* data)
{
	Measurements mapBits;
	for (int i = 0; i < CANT_PAGES; i++)
	{
		mapBits = w25q80db_read(i * SIZE_PAGE);
		for (int j = 1; j < sizeof(Measurements); j++)
		{
			if (((uint8_t *)&mapBits)[j] == 0xFF)
			{
				Measurements temp = w25q80db_read(j * sizeof(Measurements) + i * SIZE_PAGE);
				if (temp.id == id)
				{
					memcpy(data, &temp, sizeof(Measurements));
					return true;
				}
			}
		}
	}
	return false;
}

/***********************************************************************************************************************************
 *** PRIVATE FUNCTION
 **********************************************************************************************************************************/

static int isAvailableForWrite(Measurements page)
{
	for (int i = 1; i < sizeof(Measurements); i++)
	{
		if ( ((uint8_t *)&page)[i] == 0)
		{
			return i;
		}
	}
	return -1;
}

/*--------------------------------------------------------------------------------------------------------------------------------*/
