/*******************************************************************************************************************************//**
 *
 * @file		w25q80dv.c
 * @proyect		EXAMPLE
 * @author		Velazquez LautaroÂ¿
 *
 **********************************************************************************************************************************/


/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/

#include "w25q80dv.h"
#include <string.h>

/***********************************************************************************************************************************
 *** PRIVATE DEFINES
 **********************************************************************************************************************************/

#define WRITE_ENABLE					0x06
#define READ_DATA						0x03
#define PAGE_PROGRAM					0x02
#define WRITE_STATUS_REGISTER			0x01
#define SOFTWARE_PROTECTION_ENABLE_0	0x00
#define SOFTWARE_PROTECTION_ENABLE_1	0x00

/***********************************************************************************************************************************
 *** PRIVATE MACROS
 **********************************************************************************************************************************/

#define INIT_CONECTION(X)		{HAL_GPIO_WritePin(SC_GPIO_Port, SC_Pin, GPIO_PIN_RESET);	\
								X; HAL_GPIO_WritePin(SC_GPIO_Port, SC_Pin, GPIO_PIN_SET); }

#define TRANSMIT(pData, Size)	INIT_CONECTION(HAL_SPI_Transmit(&hspi1, pData, Size, 1000))

#define TRANSMIT_RECIVE(pTxData, pRxData, Size)		INIT_CONECTION(HAL_SPI_TransmitReceive(&hspi1, pTxData, pRxData, Size, 1000))

/***********************************************************************************************************************************
 *** PRIVATE DATA
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PUBLIC VARIABLES
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE VARIABLES
 **********************************************************************************************************************************/



/***********************************************************************************************************************************
 *** PRIVATE FUNCTIONS PROTOTYPE
 **********************************************************************************************************************************/

static void w25q80dv_write_enable();

/***********************************************************************************************************************************
 *** PUBLIC FUNCTIONS
 **********************************************************************************************************************************/

void w25q80dv_init()
{
	w25q80dv_write_enable();
	uint8_t pData[3] = {WRITE_STATUS_REGISTER, SOFTWARE_PROTECTION_ENABLE_0, SOFTWARE_PROTECTION_ENABLE_1};
	TRANSMIT(pData, sizeof(pData));
}

void w25q80dv_write(Measurements data, uint32_t dir)
{
	uint8_t pData[20];
	dir |= (PAGE_PROGRAM << 24U);
	memcpy(pData, &dir, 4);
	memcpy(pData + 4, &data, sizeof(Measurements));
	w25q80dv_write_enable();
	TRANSMIT(pData, 20);
}

Measurements w25q80db_read(uint32_t dir)
{
	Measurements pTxData, pRxData;
	dir |= (READ_DATA << 24U);
	memcpy(&pTxData, &dir, sizeof(dir));
	TRANSMIT_RECIVE((uint8_t*)&pTxData, (uint8_t*)&pRxData, sizeof(Measurements));
	return pRxData;
}

/***********************************************************************************************************************************
 *** PRIVATE FUNCTION
 **********************************************************************************************************************************/

static void w25q80dv_write_enable()
{
	uint8_t pData = WRITE_ENABLE;
	TRANSMIT(&pData, sizeof(pData));
}

/*--------------------------------------------------------------------------------------------------------------------------------*/
